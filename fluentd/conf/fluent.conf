<s>
  log_level info
</s>

<source>
  @type syslog
  tag syslog.logs
  port 5514
  bind 0.0.0.0
  <transport udp>
  </transport>
  <parse>
    @type syslog
    with_priority true
    message_format rfc5424
  </parse>
</source>

<filter syslog.**>
  @type parser
  key_name message
  reserve_data true
  <parse>
    @type regexp
    expression /.*\[(?<structured_data>.*)\]/
  </parse>
</filter>

<filter syslog.**>
  @type record_transformer
  enable_ruby true
  <record>
    activity_type ${record.dig("structured_data") =~ /ActivityType="([^"]*)"/ ? $1 : nil}
    user_name ${record.dig("structured_data") =~ /UserName="([^"]*)"/ ? $1 : nil}
    object_name ${record.dig("structured_data") =~ /ObjectName="([^"]*)"/ ? $1 : nil}
    vbr_hostname ${record.dig("structured_data") =~ /VbrHostName="([^"]*)"/ ? $1 : nil}
    detection_time ${record.dig("structured_data") =~ /DetectionTimeUTC="([^"]*)"/ ? $1 : nil}
    oib_id ${record.dig("structured_data") =~ /OibID="([^"]*)"/ ? $1 : nil}
    threat_level ${record.dig("structured_data") =~ /ActivityType="EncryptedData"/ ? "HIGH" : "MEDIUM"}
    event_category "malware"
    source_type "veeam"
    vendor "veeam"
    source_host ${record["host"]}  # Changed from host_name to source_host
  </record>
</filter>

<filter syslog.**>
  @type record_transformer
  <record>
    # Remove the original problematic 'host' field
    host ${record.delete("host")}
  </record>
  remove_keys host
</filter>

<filter syslog.**>
  @type grep
  <regexp>
    key ident
    pattern /Veeam/
  </regexp>
</filter>

<match syslog.**>
  @type elasticsearch
  host elasticsearch
  port 9200
  user elastic
  password YourNewPassword
  logstash_format true
  logstash_prefix veeam-logs
  <buffer>
    flush_mode immediate
  </buffer>
</match>
