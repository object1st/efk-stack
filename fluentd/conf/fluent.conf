<system>
  log_level info
</system>

# Syslog Input
<source>
  @type syslog
  tag syslog.logs
  port 5514
  bind 0.0.0.0
  <transport udp>
  </transport>
  <parse>
    @type syslog
    with_priority true
    message_format rfc5424
  </parse>
</source>

# Parse Veeam structured data
<filter syslog.**>
  @type parser
  key_name message
  reserve_data true
  <parse>
    @type regexp
    expression /.*\[(?<structured_data>.*)\]/
    <extract>
      tag structured
    </extract>
  </parse>
</filter>

# Extract specific Veeam fields
<filter syslog.**>
  @type record_transformer
  enable_ruby true
  <record>
    activity_type ${record.dig("structured_data") =~ /ActivityType="([^"]*)"/ ? $1 : nil}
    user_name ${record.dig("structured_data") =~ /UserName="([^"]*)"/ ? $1 : nil}
    object_name ${record.dig("structured_data") =~ /ObjectName="([^"]*)"/ ? $1 : nil}
    vbr_hostname ${record.dig("structured_data") =~ /VbrHostName="([^"]*)"/ ? $1 : nil}
    detection_time ${record.dig("structured_data") =~ /DetectionTimeUTC="([^"]*)"/ ? $1 : nil}
    oib_id ${record.dig("structured_data") =~ /OibID="([^"]*)"/ ? $1 : nil}
    
    # Security categorization
    threat_level ${record.dig("structured_data") =~ /ActivityType="EncryptedData"/ ? "HIGH" : "MEDIUM"}
    event_category "malware"
    event_type "detection"
    
    # ECS (Elastic Common Schema) compliance
    "event.kind" "alert"
    "event.category" ["malware", "host"]
    "event.type" ["info"]
    "event.outcome" "unknown"
    "host.name" ${record["host"]}
    "user.name" ${record.dig("structured_data") =~ /UserName="([^"]*)"/ ? $1&.split('\\')&.last : nil}
    "user.domain" ${record.dig("structured_data") =~ /UserName="([^"]*)"/ ? $1&.split('\\')&.first : nil}
  </record>
</filter>

# Add threat intelligence context
<filter syslog.**>
  @type record_transformer
  <record>
    # MITRE ATT&CK mapping
    "threat.technique.id" "T1486"
    "threat.technique.name" "Data Encrypted for Impact"
    "threat.tactic.id" "TA0040"
    "threat.tactic.name" "Impact"
    
    # Rule information for Elastic Security
    "rule.name" "Veeam Malware Detection Alert"
    "rule.description" "Potential malware activity detected by Veeam Backup & Replication"
    "rule.severity" "high"
    "rule.risk_score" 75
  </record>
</filter>

# Output to Elasticsearch with better indexing
<match syslog.**>
  @type elasticsearch
  host elasticsearch
  port 9200
  index_name veeam-security-alerts
  template_name veeam-security-template
  template_file /fluentd/etc/veeam-template.json
  include_tag_key true
  tag_key @log_name
  flush_interval 1s
  <buffer>
    @type file
    path /var/log/fluent/veeam-buffer
    flush_mode interval
    flush_interval 10s
    chunk_limit_size 1m
  </buffer>
</match>
